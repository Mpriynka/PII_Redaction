<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local PII Redactor</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script type="module">
    import { AutoTokenizer, env } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers';

    env.allowLocalModels = true;
    env.allowRemoteModels = false;
    env.localModelPath = 'models/';

    // Configuration
    const MODEL_FOLDER = "pii-model"; 
    
    // We will load these dynamically now!
    let ID2LABEL = null; 
    let session = null;
    let tokenizer = null;

    async function loadModel() {
        const status = document.getElementById('status');
        status.innerText = "‚è≥ Loading model, tokenizer, and labels...";
        
        try {
            // 1. Load the Label Map (The Translation Dictionary)
            const response = await fetch(`./models/${MODEL_FOLDER}/labels.json`);
            if (!response.ok) throw new Error("Could not find labels.json!");
            const labelsConfig = await response.json();
            
            // Handle different JSON formats (sometimes keys are strings "0", sometimes ints)
            ID2LABEL = {};
            for (const [key, value] of Object.entries(labelsConfig)) {
                ID2LABEL[parseInt(key)] = value;
            }
            console.log("‚úÖ Loaded Labels:", ID2LABEL);

            // 2. Load Tokenizer & Model
            tokenizer = await AutoTokenizer.from_pretrained(MODEL_FOLDER);
            session = await ort.InferenceSession.create(`./models/${MODEL_FOLDER}/model.onnx`, { executionProviders: ['wasm'] });

            status.innerText = "‚úÖ System Ready! (Loaded " + Object.keys(ID2LABEL).length + " labels)";
            document.getElementById('analyzeBtn').disabled = false;
        } catch (e) {
            status.innerText = "‚ùå Error: " + e.message;
            console.error(e);
        }
    }

    async function analyzeText() {
        const text = document.getElementById('inputText').value;
        if (!text) return;
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = "Processing...";

        // 1. Tokenize
        const encoded = await tokenizer(text, {
            return_tensors: 'ort',
            padding: true,
            truncation: true,
            max_length: 512
        });

        // 2. Inference
        const feeds = {
            input_ids: encoded.input_ids,
            attention_mask: encoded.attention_mask
        };
        const results = await session.run(feeds);
        
        // 3. Process Results
        const logits = results.logits.data; 
        const [batchSize, seqLen, numLabels] = results.logits.dims;
        const tokenIds = encoded.input_ids.data;
        
        let newHtml = "";
        
        for (let i = 0; i < seqLen; i++) {
            // Find the best label (argmax)
            let maxScore = -Infinity;
            let predictedId = 0;
            
            for (let j = 0; j < numLabels; j++) {
                const val = logits[i * numLabels + j];
                if (val > maxScore) {
                    maxScore = val;
                    predictedId = j;
                }
            }

            const label = ID2LABEL[predictedId] || "O";
            const tokenId = Number(tokenIds[i]); // Ensure number
            
            // Skip Special Tokens ([CLS], [SEP], [PAD])
            // 101=CLS, 102=SEP, 0=PAD (Standard BERT)
            if (tokenId === 101 || tokenId === 102 || tokenId === 0) continue;

            // Get the word
            let word = tokenizer.model.vocab[tokenId];
            if (!word) word = "";

            // --- DETOKENIZER LOGIC (Make it look pretty) ---
            // If it's a subword (e.g., ##ing), attach it to the previous word
            if (word.startsWith("##")) {
                word = word.substring(2);
                // Remove the space we added previously if this is a subword suffix
                if (newHtml.endsWith(" ")) { 
                    newHtml = newHtml.slice(0, -1); 
                }
            } else if (newHtml.length > 0 && !word.startsWith(".") && !word.startsWith(",")) {
                 // Add space before new words (but not punctuation)
                newHtml += " ";
            }

            // --- REDACTION LOGIC ---
            if (label !== "O") {
                console.log(`Found PII: ${word} -> ${label}`); // Debug log
                // Color code different entities
                let color = "#ffcccc"; // Default Red
                if (label.includes("NAME")) color = "#ccffcc"; // Green
                if (label.includes("EMAIL")) color = "#ccccff"; // Blue
                
                newHtml += `<span style="background-color: ${color}; padding: 2px 4px; border-radius: 4px; font-weight: bold;" title="${label}">[${label}]</span>`;
            } else {
                newHtml += word;
            }
        }

        outputDiv.innerHTML = newHtml;
    }

    // Initialize
    loadModel();
    window.analyzeText = analyzeText;
</script>
<style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        textarea { width: 100%; height: 100px; margin-bottom: 1rem; }
        #output { padding: 1rem; border: 1px solid #ddd; background: #f9f9f9; min-height: 50px; line-height: 1.6; }
        .status { color: #666; font-size: 0.9rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <h1>üîí Local Browser PII Redactor</h1>
    <div id="status" class="status">Initializing...</div>
    
    <textarea id="inputText" placeholder="Paste text here (e.g., My email is john@example.com)..."></textarea>
    <button id="analyzeBtn" onclick="analyzeText()" disabled>Redact PII</button>
    
    <h3>Output:</h3>
    <div id="output"></div>
</body>
</html>
